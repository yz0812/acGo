<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>签到管理系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>签到管理系统</h1>
            <div class="header-actions">
                <button onclick="loadStats()" class="btn btn-secondary">刷新统计</button>
                <button onclick="showSystemSettingsModal()" class="btn btn-secondary">系统设置</button>
                <a href="{{ url_for('logout') }}" class="btn btn-secondary">退出登录</a>
            </div>
        </header>

        <!-- 统计面板 -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-label">账号总数</div>
                <div class="stat-value" id="totalAccounts">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">启用账号</div>
                <div class="stat-value" id="enabledAccounts">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">签到总数</div>
                <div class="stat-value" id="totalLogs">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">成功次数</div>
                <div class="stat-value" id="successLogs">0</div>
            </div>
        </div>

        <!-- 账号管理 -->
        <section class="section">
            <div class="section-header">
                <h2>账号管理</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="showAddModal()" class="btn btn-primary">添加账号</button>
                    <button onclick="exportAccounts()" class="btn btn-secondary">导出账号</button>
                    <button onclick="document.getElementById('importFile').click()" class="btn btn-secondary">导入账号</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importAccounts(event)">
                </div>
            </div>

            <div class="table-container">
                <table id="accountsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>账号名称</th>
                            <th>Cron表达式</th>
                            <th>重试次数</th>
                            <th>重试间隔(秒)</th>
                            <th>状态</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="accountsBody">
                        <tr><td colspan="8" style="text-align:center;">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 签到记录 -->
        <section class="section">
            <div class="section-header">
                <h2>签到记录</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="loadLogs()" class="btn btn-secondary">刷新记录</button>
                    <button onclick="clearOldLogs()" class="btn btn-warning">清除7天前</button>
                    <button onclick="clearAllLogs()" class="btn btn-danger">清除全部</button>
                </div>
            </div>

            <div class="table-container">
                <table id="logsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>账号名称</th>
                            <th>状态</th>
                            <th>响应码</th>
                            <th>响应内容</th>
                            <th>错误信息</th>
                            <th>执行时间</th>
                        </tr>
                    </thead>
                    <tbody id="logsBody">
                        <tr><td colspan="7" style="text-align:center;">加载中...</td></tr>
                    </tbody>
                </table>

                <!-- 分页控件 -->
                <div class="pagination" id="logsPagination" style="display: none;">
                    <button onclick="loadLogsPage(currentPage - 1)" id="prevBtn" class="btn btn-sm btn-secondary">上一页</button>
                    <span id="pageInfo" style="margin: 0 15px;">第 1 页 / 共 1 页</span>
                    <button onclick="loadLogsPage(currentPage + 1)" id="nextBtn" class="btn btn-sm btn-secondary">下一页</button>
                </div>
            </div>
        </section>

        <!-- Webhook 通知配置 -->
        <section class="section">
            <div class="section-header">
                <h2>Webhook 通知</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="testWebhook()" class="btn btn-secondary">测试 Webhook</button>
                    <button onclick="saveWebhook()" class="btn btn-primary">保存配置</button>
                </div>
            </div>

            <div style="max-width: 800px;">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="webhookEnabled">
                        启用 Webhook 通知
                    </label>
                    <small>启用后，每次签到任务执行完成时会调用 Webhook</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="webhookIncludeResponse">
                        包含签到响应内容
                    </label>
                    <small>启用后，Webhook 数据中会包含完整的签到响应内容（response_body）</small>
                </div>

                <div class="form-group">
                    <label for="webhookUrl">Webhook URL *</label>
                    <input type="text" id="webhookUrl" placeholder="https://example.com/webhook">
                    <small>签到完成后会向此 URL 发送 POST 请求</small>
                </div>

                <div class="form-group">
                    <label for="webhookMethod">请求方法</label>
                    <select id="webhookMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="POST">POST</option>
                        <option value="GET">GET</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="webhookHeaders">自定义请求头（可选）</label>
                    <textarea id="webhookHeaders" rows="5" placeholder='{"Authorization": "Bearer token"}'></textarea>
                    <small style="display: block; margin-top: 5px;">
                        <strong>JSON 格式示例：</strong><br>
                        <strong>1. JSON 格式（默认）：</strong>不设置或设置 <code>{"Content-Type": "application/json"}</code><br>
                        <strong>2. Form 表单格式：</strong><code>{"Content-Type": "application/x-www-form-urlencoded"}</code><br>
                        <strong>3. Multipart 格式：</strong><code>{"Content-Type": "multipart/form-data"}</code><br>
                        <strong>4. 自定义认证：</strong><code>{"Authorization": "Bearer your_token"}</code>
                    </small>
                </div>

                <div class="webhook-info">
                    <h4>Webhook 数据格式</h4>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto;">
{
  "title": "账号名称",
  "account_name": "账号名称",
  "status": "success",  // success 或 failed
  "response_code": 200,
  "date": "2025-12-22 10:00:00",
  "message": "签到成功",
  "response_body": "..."  // 仅当启用"包含签到响应内容"时包含此字段
}</pre>
                </div>
            </div>
        </section>

    </div>

    <!-- 添加/编辑账号模态框 -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">添加账号</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="accountForm">
                    <input type="hidden" id="accountId">
                    
                    <div class="form-group">
                        <label for="accountName">账号名称 *</label>
                        <input type="text" id="accountName" required>
                    </div>

                    <div class="form-group">
                        <label for="curlCommand">Curl 命令 *</label>
                        <textarea id="curlCommand" rows="6" required placeholder="粘贴完整的 curl 命令，例如：&#10;curl 'https://api.example.com/checkin' \&#10;  -H 'Authorization: Bearer token123' \&#10;  -H 'Content-Type: application/json' \&#10;  --data-raw '{&quot;user_id&quot;: 123}'"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="cronExpr">Cron 表达式 *</label>
                        <input type="text" id="cronExpr" value="0 8 * * *" required>
                        <small style="display: block; margin-top: 5px;">
                            <strong>支持两种格式：</strong><br>
                            <strong>1. 标准 Cron：</strong>分 时 日 月 周<br>
                            &nbsp;&nbsp;&nbsp;• <code>0 8 * * *</code> → 每天 8:00 执行<br>
                            &nbsp;&nbsp;&nbsp;• <code>30 14 * * 1-5</code> → 每周一到周五 14:30 执行<br>
                            <strong>2. 随机时间窗口：</strong>R(开始时间-结束时间) 日 月 周<br>
                            &nbsp;&nbsp;&nbsp;• <code>R(09:00-09:30) * * *</code> → 每天 9:00-9:30 之间随机执行<br>
                            &nbsp;&nbsp;&nbsp;• <code>R(08:00-08:15) * * 1-5</code> → 每周一到周五 8:00-8:15 随机执行<br>
                            &nbsp;&nbsp;&nbsp;• <code>R(20:00-22:00) 1 * *</code> → 每月1号 20:00-22:00 随机执行
                        </small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="retryCount">重试次数</label>
                            <input type="number" id="retryCount" value="3" min="0" max="10">
                        </div>

                        <div class="form-group">
                            <label for="retryInterval">重试间隔(秒)</label>
                            <input type="number" id="retryInterval" value="60" min="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enabled" checked>
                            启用定时任务
                        </label>
                    </div>

                    <div class="form-actions">
                        <button type="button" onclick="closeModal()" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 响应详情模态框 -->
    <div id="responseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>响应详情</h3>
                <span class="close" onclick="closeResponseModal()">&times;</span>
            </div>
            <div class="modal-body">
                <pre id="responseContent" style="white-space: pre-wrap; word-wrap: break-word; max-height: 500px; overflow-y: auto; background: #f5f5f5; padding: 15px; border-radius: 4px;"></pre>
            </div>
        </div>
    </div>

    <!-- 系统设置模态框 -->
    <div id="systemSettingsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>系统设置</h3>
                <span class="close" onclick="closeSystemSettingsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- 修改密码 -->
                <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-top: 0;">修改管理员密码</h4>
                    
                    <div class="form-group">
                        <label for="oldPassword">旧密码 *</label>
                        <input type="password" id="oldPassword" placeholder="请输入旧密码">
                    </div>

                    <div class="form-group">
                        <label for="newPassword">新密码 *</label>
                        <input type="password" id="newPassword" placeholder="请输入新密码（至少6位）">
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">确认新密码 *</label>
                        <input type="password" id="confirmPassword" placeholder="请再次输入新密码">
                    </div>

                    <button onclick="changePassword()" class="btn btn-primary">修改密码</button>
                </div>

                <!-- 自动清理配置 -->
                <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin-top: 0;">签到记录自动清理</h4>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autoCleanLogs">
                            启用自动清理
                        </label>
                        <small>启用后，每天凌晨 3:00 自动清理超出限制的旧记录</small>
                    </div>

                    <div class="form-group">
                        <label for="maxLogsCount">最大记录数</label>
                        <input type="number" id="maxLogsCount" value="500" min="100" max="10000">
                        <small>保留最新的 N 条签到记录，超出部分将被自动清理（最小 100 条）</small>
                    </div>
                </div>

                <div class="form-actions">
                    <button onclick="closeSystemSettingsModal()" class="btn btn-secondary">取消</button>
                    <button onclick="saveSystemConfig()" class="btn btn-primary">保存配置</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentPage = 1;
        let totalPages = 1;

        // HTML 转义函数（防止 XSS）
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
        }

        // 显示响应详情
        function showResponseDetail(element) {
            const content = element.getAttribute('data-content');
            // 解码 HTML 实体
            const textarea = document.createElement('textarea');
            textarea.innerHTML = content;
            const decoded = textarea.value;

            document.getElementById('responseContent').textContent = decoded;
            document.getElementById('responseModal').style.display = 'block';
        }

        // 关闭响应详情模态框
        function closeResponseModal() {
            document.getElementById('responseModal').style.display = 'none';
        }

        // 显示系统设置模态框
        function showSystemSettingsModal() {
            loadSystemConfig();
            document.getElementById('systemSettingsModal').style.display = 'block';
        }

        // 关闭系统设置模态框
        function closeSystemSettingsModal() {
            document.getElementById('systemSettingsModal').style.display = 'none';
            // 清空密码字段
            document.getElementById('oldPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadAccounts();
            loadLogsPage(1);
            loadWebhookConfig();
        });

        // 加载统计数据
        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('totalAccounts').textContent = data.data.total_accounts;
                    document.getElementById('enabledAccounts').textContent = data.data.enabled_accounts;
                    document.getElementById('totalLogs').textContent = data.data.total_logs;
                    document.getElementById('successLogs').textContent = data.data.success_logs;
                }
            } catch (error) {
                console.error('加载统计失败:', error);
            }
        }

        // 加载账号列表
        async function loadAccounts() {
            try {
                const res = await fetch('/api/accounts');
                const data = await res.json();
                
                if (data.success) {
                    const tbody = document.getElementById('accountsBody');
                    
                    if (data.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">暂无账号</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = data.data.map(acc => `
                        <tr>
                            <td>${acc.id}</td>
                            <td>${acc.name}</td>
                            <td>${acc.cron_expr}</td>
                            <td>${acc.retry_count}</td>
                            <td>${acc.retry_interval}</td>
                            <td>
                                <span class="badge ${acc.enabled ? 'badge-success' : 'badge-danger'}">
                                    ${acc.enabled ? '启用' : '禁用'}
                                </span>
                            </td>
                            <td>${acc.created_at}</td>
                            <td>
                                <button onclick="manualCheckin(${acc.id})" class="btn btn-sm btn-success">立即签到</button>
                                <button onclick="editAccount(${acc.id})" class="btn btn-sm btn-primary">编辑</button>
                                <button onclick="deleteAccount(${acc.id})" class="btn btn-sm btn-danger">删除</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载账号失败:', error);
            }
        }

        // 加载签到记录（分页）
        async function loadLogsPage(page) {
            if (page < 1) return;

            try {
                const res = await fetch(`/api/logs?page=${page}&page_size=10`);
                const data = await res.json();

                if (data.success) {
                    const tbody = document.getElementById('logsBody');

                    if (data.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">暂无记录</td></tr>';
                        document.getElementById('logsPagination').style.display = 'none';
                        return;
                    }

                    tbody.innerHTML = data.data.map(log => `
                        <tr>
                            <td>${log.id}</td>
                            <td>${log.account_name}</td>
                            <td>
                                <span class="badge ${log.status === 'success' ? 'badge-success' : 'badge-danger'}">
                                    ${log.status === 'success' ? '成功' : '失败'}
                                </span>
                            </td>
                            <td>${log.response_code || '-'}</td>
                            <td>
                                ${log.response_body ?
                                    `<span class="clickable" data-content="${escapeHtml(log.response_body)}" onclick="showResponseDetail(this)" title="点击查看完整内容">${escapeHtml(log.response_body.substring(0, 50))}...</span>`
                                    : '-'}
                            </td>
                            <td>
                                ${log.error_message ?
                                    `<span class="clickable" data-content="${escapeHtml(log.error_message)}" onclick="showResponseDetail(this)" title="点击查看完整内容">${escapeHtml(log.error_message.substring(0, 30))}...</span>`
                                    : '-'}
                            </td>
                            <td>${log.executed_at}</td>
                        </tr>
                    `).join('');

                    // 更新分页信息
                    currentPage = page;
                    totalPages = Math.ceil(data.total / data.page_size);

                    document.getElementById('pageInfo').textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页 (总计 ${data.total} 条)`;
                    document.getElementById('prevBtn').disabled = currentPage <= 1;
                    document.getElementById('nextBtn').disabled = currentPage >= totalPages;
                    document.getElementById('logsPagination').style.display = 'flex';
                }
            } catch (error) {
                console.error('加载日志失败:', error);
            }
        }

        // 兼容旧的 loadLogs 函数
        function loadLogs() {
            loadLogsPage(1);
        }

        // 显示添加模态框
        function showAddModal() {
            document.getElementById('modalTitle').textContent = '添加账号';
            document.getElementById('accountForm').reset();
            document.getElementById('accountId').value = '';
            document.getElementById('accountModal').style.display = 'block';
        }

        // 编辑账号
        async function editAccount(id) {
            try {
                const res = await fetch('/api/accounts');
                const data = await res.json();
                
                if (data.success) {
                    const account = data.data.find(acc => acc.id === id);
                    
                    if (account) {
                        document.getElementById('modalTitle').textContent = '编辑账号';
                        document.getElementById('accountId').value = account.id;
                        document.getElementById('accountName').value = account.name;
                        document.getElementById('curlCommand').value = account.curl_command;
                        document.getElementById('cronExpr').value = account.cron_expr;
                        document.getElementById('retryCount').value = account.retry_count;
                        document.getElementById('retryInterval').value = account.retry_interval;
                        document.getElementById('enabled').checked = account.enabled;
                        document.getElementById('accountModal').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('加载账号失败:', error);
            }
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('accountModal').style.display = 'none';
        }

        // 提交表单
        document.getElementById('accountForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('accountId').value;
            const formData = {
                name: document.getElementById('accountName').value,
                curl_command: document.getElementById('curlCommand').value,
                cron_expr: document.getElementById('cronExpr').value,
                retry_count: parseInt(document.getElementById('retryCount').value),
                retry_interval: parseInt(document.getElementById('retryInterval').value),
                enabled: document.getElementById('enabled').checked
            };
            
            try {
                const url = id ? `/api/accounts/${id}` : '/api/accounts';
                const method = id ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert(data.message);
                    closeModal();
                    loadAccounts();
                    loadStats();
                } else {
                    alert('操作失败: ' + data.message);
                }
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        });

        // 删除账号
        async function deleteAccount(id) {
            if (!confirm('确定要删除这个账号吗？')) return;
            
            try {
                const res = await fetch(`/api/accounts/${id}`, {method: 'DELETE'});
                const data = await res.json();
                
                if (data.success) {
                    alert(data.message);
                    loadAccounts();
                    loadStats();
                } else {
                    alert('删除失败: ' + data.message);
                }
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }

        // 手动签到
        async function manualCheckin(id) {
            if (!confirm('确定要立即执行签到吗？')) return;

            try {
                const res = await fetch(`/api/checkin/${id}`, {method: 'POST'});
                const data = await res.json();

                alert(data.message);

                if (data.success) {
                    loadLogs();
                    loadStats();
                }
            } catch (error) {
                alert('签到失败: ' + error.message);
            }
        }

        // 清除7天前的日志
        async function clearOldLogs() {
            if (!confirm('确定要清除7天前的签到记录吗？\n\n此操作不可恢复！')) return;

            // 二次确认
            if (!confirm('再次确认：真的要删除7天前的所有记录吗？')) return;

            try {
                const res = await fetch('/api/logs/clear?days=7', {method: 'DELETE'});
                const data = await res.json();

                alert(data.message);

                if (data.success) {
                    loadLogs();
                    loadStats();
                }
            } catch (error) {
                alert('清除失败: ' + error.message);
            }
        }

        // 清除全部日志
        async function clearAllLogs() {
            if (!confirm('⚠️ 警告：确定要清除全部签到记录吗？\n\n此操作不可恢复！')) return;

            // 二次确认
            if (!confirm('⚠️ 最后确认：真的要删除所有记录吗？\n\n请输入"确认删除"后点击确定')) {
                return;
            }

            try {
                const res = await fetch('/api/logs/clear', {method: 'DELETE'});
                const data = await res.json();

                alert(data.message);

                if (data.success) {
                    loadLogs();
                    loadStats();
                }
            } catch (error) {
                alert('清除失败: ' + error.message);
            }
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const accountModal = document.getElementById('accountModal');
            const responseModal = document.getElementById('responseModal');
            const systemSettingsModal = document.getElementById('systemSettingsModal');
            
            if (event.target === accountModal) {
                closeModal();
            }
            if (event.target === responseModal) {
                closeResponseModal();
            }
            if (event.target === systemSettingsModal) {
                closeSystemSettingsModal();
            }
        }

        // 加载 Webhook 配置
        async function loadWebhookConfig() {
            try {
                const res = await fetch('/api/webhook/config');
                const data = await res.json();

                if (data.success) {
                    document.getElementById('webhookEnabled').checked = data.data.enabled || false;
                    document.getElementById('webhookIncludeResponse').checked = data.data.include_response || false;
                    document.getElementById('webhookUrl').value = data.data.url || '';
                    document.getElementById('webhookMethod').value = data.data.method || 'POST';
                    document.getElementById('webhookHeaders').value = data.data.headers || '';
                }
            } catch (error) {
                console.error('加载 Webhook 配置失败:', error);
            }
        }

        // 保存 Webhook 配置
        async function saveWebhook() {
            const config = {
                enabled: document.getElementById('webhookEnabled').checked,
                include_response: document.getElementById('webhookIncludeResponse').checked,
                url: document.getElementById('webhookUrl').value,
                method: document.getElementById('webhookMethod').value,
                headers: document.getElementById('webhookHeaders').value
            };

            // 验证 URL
            if (config.enabled && !config.url) {
                alert('请输入 Webhook URL');
                return;
            }

            // 验证 Headers JSON 格式
            if (config.headers) {
                try {
                    JSON.parse(config.headers);
                } catch (e) {
                    alert('自定义请求头格式错误，请输入有效的 JSON');
                    return;
                }
            }

            try {
                const res = await fetch('/api/webhook/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });

                const data = await res.json();

                if (data.success) {
                    alert('Webhook 配置保存成功');
                } else {
                    alert('保存失败: ' + data.message);
                }
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        }

        // 测试 Webhook
        async function testWebhook() {
            const url = document.getElementById('webhookUrl').value;

            if (!url) {
                alert('请先输入 Webhook URL');
                return;
            }

            if (!confirm('确定要发送测试通知到 Webhook 吗？')) return;

            try {
                const res = await fetch('/api/webhook/test', {method: 'POST'});
                const data = await res.json();

                if (data.success) {
                    alert('测试通知发送成功！\n\n请检查 Webhook 接收端是否收到测试数据。');
                } else {
                    alert('测试失败: ' + data.message);
                }
            } catch (error) {
                alert('测试失败: ' + error.message);
            }
        }

        // 导出账号
        async function exportAccounts() {
            try {
                const res = await fetch('/api/accounts/export');
                const data = await res.json();

                if (data.success) {
                    // 创建 Blob 并下载
                    const blob = new Blob([JSON.stringify(data.data, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `acgo_accounts_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    alert(`成功导出 ${data.data.length} 个账号`);
                } else {
                    alert('导出失败: ' + data.message);
                }
            } catch (error) {
                alert('导出失败: ' + error.message);
            }
        }

        // 导入账号
        async function importAccounts(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 验证文件类型
            if (!file.name.endsWith('.json')) {
                alert('请选择 JSON 文件');
                event.target.value = '';
                return;
            }

            try {
                const text = await file.text();
                const accounts = JSON.parse(text);

                // 验证数据格式
                if (!Array.isArray(accounts)) {
                    alert('JSON 格式错误：根元素必须是数组');
                    event.target.value = '';
                    return;
                }

                if (accounts.length === 0) {
                    alert('文件中没有账号数据');
                    event.target.value = '';
                    return;
                }

                // 确认导入
                if (!confirm(`确定要导入 ${accounts.length} 个账号吗？\n\n重名账号将自动重命名。`)) {
                    event.target.value = '';
                    return;
                }

                // 发送导入请求
                const res = await fetch('/api/accounts/import', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({accounts: accounts})
                });

                const data = await res.json();

                if (data.success) {
                    alert(`导入完成！\n\n成功: ${data.imported} 个\n失败: ${data.failed} 个\n重命名: ${data.renamed} 个`);
                    loadAccounts();
                    loadStats();
                } else {
                    alert('导入失败: ' + data.message);
                }
            } catch (error) {
                if (error instanceof SyntaxError) {
                    alert('JSON 格式错误: ' + error.message);
                } else {
                    alert('导入失败: ' + error.message);
                }
            } finally {
                // 清空文件选择，允许重复导入同一文件
                event.target.value = '';
            }
        }
        // 加载系统配置
        async function loadSystemConfig() {
            try {
                const res = await fetch('/api/system/config');
                const data = await res.json();

                if (data.success) {
                    document.getElementById('autoCleanLogs').checked = data.data.auto_clean_logs || false;
                    document.getElementById('maxLogsCount').value = data.data.max_logs_count || 500;
                }
            } catch (error) {
                console.error('加载系统配置失败:', error);
            }
        }

        // 保存系统配置
        async function saveSystemConfig() {
            const config = {
                auto_clean_logs: document.getElementById('autoCleanLogs').checked,
                max_logs_count: parseInt(document.getElementById('maxLogsCount').value)
            };

            // 验证最大记录数
            if (config.max_logs_count < 100) {
                alert('最大记录数不能小于 100');
                return;
            }

            try {
                const res = await fetch('/api/system/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });

                const data = await res.json();

                if (data.success) {
                    alert('系统配置保存成功');
                    closeSystemSettingsModal();
                } else {
                    alert('保存失败: ' + data.message);
                }
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        }

        // 修改密码
        async function changePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // 验证输入
            if (!oldPassword || !newPassword || !confirmPassword) {
                alert('请填写所有密码字段');
                return;
            }

            if (newPassword.length < 6) {
                alert('新密码长度不能少于 6 位');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('两次输入的新密码不一致');
                return;
            }

            if (!confirm('确定要修改管理员密码吗？修改后需要重新登录。')) {
                return;
            }

            try {
                const res = await fetch('/api/system/password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword
                    })
                });

                const data = await res.json();

                if (data.success) {
                    alert(data.message);
                    // 清空密码字段
                    document.getElementById('oldPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    // 跳转到登录页
                    window.location.href = '/logout';
                } else {
                    alert('修改失败: ' + data.message);
                }
            } catch (error) {
                alert('修改失败: ' + error.message);
            }
        }
    </script>
</body>
</html>
