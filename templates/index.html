<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>签到管理系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>签到管理系统</h1>
            <div class="header-actions">
                <button onclick="loadStats()" class="btn btn-secondary">刷新统计</button>
                <button onclick="showSystemSettingsModal()" class="btn btn-secondary">系统设置</button>
                <a href="{{ url_for('logout') }}" class="btn btn-secondary">退出登录</a>
            </div>
        </header>

        <!-- 统计面板 -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-label">账号总数</div>
                <div class="stat-value" id="totalAccounts">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">启用账号</div>
                <div class="stat-value" id="enabledAccounts">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">签到总数</div>
                <div class="stat-value" id="totalLogs">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">成功次数</div>
                <div class="stat-value" id="successLogs">0</div>
            </div>
        </div>

        <!-- 账号管理 -->
        <section class="section">
            <div class="section-header">
                <h2>账号管理</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="showAddModal()" class="btn btn-primary">添加账号</button>
{#                    <button onclick="showAppSelectionModal()" class="btn btn-success">添加自定义账号</button>#}
                    <button onclick="exportAccounts()" class="btn btn-secondary">导出账号</button>
                    <button onclick="document.getElementById('importFile').click()" class="btn btn-secondary">导入账号</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importAccounts(event)">
                </div>
            </div>

            <div class="table-container">
                <table id="accountsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>账号名称</th>
                            <th>Cron表达式</th>
                            <th>重试次数</th>
                            <th>重试间隔(秒)</th>
                            <th>状态</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="accountsBody">
                        <tr><td colspan="8" style="text-align:center;">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 签到记录 -->
        <section class="section">
            <div class="section-header">
                <h2>签到记录</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="statusFilter" onchange="filterLogsByStatus()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">
                        <option value="">全部状态</option>
                        <option value="success">成功</option>
                        <option value="failed">失败</option>
                    </select>
                    <button onclick="loadLogs()" class="btn btn-secondary">刷新记录</button>
                    <button onclick="clearOldLogs()" class="btn btn-warning">清除7天前</button>
                    <button onclick="clearAllLogs()" class="btn btn-danger">清除全部</button>
                </div>
            </div>

            <div class="table-container">
                <table id="logsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>账号名称</th>
                            <th>状态</th>
                            <th>响应码</th>
                            <th>响应内容</th>
                            <th>错误信息</th>
                            <th>执行时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="logsBody">
                        <tr><td colspan="8" style="text-align:center;">加载中...</td></tr>
                    </tbody>
                </table>

                <!-- 分页控件 -->
                <div class="pagination" id="logsPagination" style="display: none;">
                    <button onclick="loadLogsPage(currentPage - 1)" id="prevBtn" class="btn btn-sm btn-secondary">上一页</button>
                    <span id="pageInfo" style="margin: 0 15px;">第 1 页 / 共 1 页</span>
                    <button onclick="loadLogsPage(currentPage + 1)" id="nextBtn" class="btn btn-sm btn-secondary">下一页</button>
                </div>
            </div>
        </section>

        <!-- Webhook 通知配置 -->
        <section class="section">
            <div class="section-header">
                <h2>Webhook 通知</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="testWebhook()" class="btn btn-secondary">测试 Webhook</button>
                    <button onclick="saveWebhook()" class="btn btn-primary">保存配置</button>
                </div>
            </div>

            <div style="max-width: 800px;">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="webhookEnabled">
                        启用 Webhook 通知
                    </label>
                    <small>启用后，每次签到任务执行完成时会调用 Webhook</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="webhookIncludeResponse">
                        包含签到响应内容
                    </label>
                    <small>启用后，Webhook 数据中会包含完整的签到响应内容（response_body）</small>
                </div>

                <div class="form-group">
                    <label for="webhookUrl">Webhook URL *</label>
                    <input type="text" id="webhookUrl" placeholder="https://example.com/webhook">
                    <small>签到完成后会向此 URL 发送 POST 请求</small>
                </div>

                <div class="form-group">
                    <label for="webhookMethod">请求方法</label>
                    <select id="webhookMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="POST">POST</option>
                        <option value="GET">GET</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="webhookHeaders">自定义请求头（可选）</label>
                    <textarea id="webhookHeaders" rows="5" placeholder='{"Authorization": "Bearer token"}'></textarea>
                    <small style="display: block; margin-top: 5px;">
                        <strong>JSON 格式示例：</strong><br>
                        <strong>1. JSON 格式（默认）：</strong>不设置或设置 <code>{"Content-Type": "application/json"}</code><br>
                        <strong>2. Form 表单格式：</strong><code>{"Content-Type": "application/x-www-form-urlencoded"}</code><br>
                        <strong>3. Multipart 格式：</strong><code>{"Content-Type": "multipart/form-data"}</code><br>
                        <strong>4. 自定义认证：</strong><code>{"Authorization": "Bearer your_token"}</code>
                    </small>
                </div>

                <div class="webhook-info">
                    <h4>Webhook 数据格式</h4>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto;">
{
  "title": "账号名称",
  "account_name": "账号名称",
  "status": "success",  // success 或 failed
  "response_code": 200,
  "date": "2025-12-22 10:00:00",
  "message": "签到成功",
  "response_body": "..."  // 仅当启用"包含签到响应内容"时包含此字段
}</pre>
                </div>
            </div>
        </section>

    </div>

    <!-- 引入所有模态框 -->
    {% include 'includes/modals.html' %}

    <!-- 引入 JavaScript -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
