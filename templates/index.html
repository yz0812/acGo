<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>签到管理系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>签到管理系统</h1>
            <div class="header-actions">
                <button onclick="loadStats()" class="btn btn-secondary">刷新统计</button>
                <a href="{{ url_for('logout') }}" class="btn btn-secondary">退出登录</a>
            </div>
        </header>

        <!-- 统计面板 -->
        <div class="stats-panel">
            <div class="stat-card">
                <div class="stat-label">账号总数</div>
                <div class="stat-value" id="totalAccounts">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">启用账号</div>
                <div class="stat-value" id="enabledAccounts">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">签到总数</div>
                <div class="stat-value" id="totalLogs">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">成功次数</div>
                <div class="stat-value" id="successLogs">0</div>
            </div>
        </div>

        <!-- 账号管理 -->
        <section class="section">
            <div class="section-header">
                <h2>账号管理</h2>
                <button onclick="showAddModal()" class="btn btn-primary">添加账号</button>
            </div>

            <div class="table-container">
                <table id="accountsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>账号名称</th>
                            <th>Cron表达式</th>
                            <th>重试次数</th>
                            <th>重试间隔(秒)</th>
                            <th>状态</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="accountsBody">
                        <tr><td colspan="8" style="text-align:center;">加载中...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 签到记录 -->
        <section class="section">
            <div class="section-header">
                <h2>签到记录</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="loadLogs()" class="btn btn-secondary">刷新记录</button>
                    <button onclick="clearOldLogs()" class="btn btn-warning">清除7天前</button>
                    <button onclick="clearAllLogs()" class="btn btn-danger">清除全部</button>
                </div>
            </div>

            <div class="table-container">
                <table id="logsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>账号名称</th>
                            <th>状态</th>
                            <th>响应码</th>
                            <th>响应内容</th>
                            <th>错误信息</th>
                            <th>执行时间</th>
                        </tr>
                    </thead>
                    <tbody id="logsBody">
                        <tr><td colspan="7" style="text-align:center;">加载中...</td></tr>
                    </tbody>
                </table>

                <!-- 分页控件 -->
                <div class="pagination" id="logsPagination" style="display: none;">
                    <button onclick="loadLogsPage(currentPage - 1)" id="prevBtn" class="btn btn-sm btn-secondary">上一页</button>
                    <span id="pageInfo" style="margin: 0 15px;">第 1 页 / 共 1 页</span>
                    <button onclick="loadLogsPage(currentPage + 1)" id="nextBtn" class="btn btn-sm btn-secondary">下一页</button>
                </div>
            </div>
        </section>

        <!-- Webhook 通知配置 -->
        <section class="section">
            <div class="section-header">
                <h2>Webhook 通知</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="testWebhook()" class="btn btn-secondary">测试 Webhook</button>
                    <button onclick="saveWebhook()" class="btn btn-primary">保存配置</button>
                </div>
            </div>

            <div style="max-width: 800px;">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="webhookEnabled">
                        启用 Webhook 通知
                    </label>
                    <small>启用后，每次签到任务执行完成时会调用 Webhook</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="webhookIncludeResponse">
                        包含签到响应内容
                    </label>
                    <small>启用后，Webhook 数据中会包含完整的签到响应内容（response_body）</small>
                </div>

                <div class="form-group">
                    <label for="webhookUrl">Webhook URL *</label>
                    <input type="text" id="webhookUrl" placeholder="https://example.com/webhook">
                    <small>签到完成后会向此 URL 发送 POST 请求</small>
                </div>

                <div class="form-group">
                    <label for="webhookMethod">请求方法</label>
                    <select id="webhookMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="POST">POST</option>
                        <option value="GET">GET</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="webhookHeaders">自定义请求头（可选）</label>
                    <textarea id="webhookHeaders" rows="3" placeholder='{"Authorization": "Bearer token", "Content-Type": "application/json"}'></textarea>
                    <small>JSON 格式，例如：{"Authorization": "Bearer token"}</small>
                </div>

                <div class="webhook-info">
                    <h4>Webhook 数据格式</h4>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 4px; overflow-x: auto;">
{
  "account_name": "账号名称",
  "status": "success",  // success 或 failed
  "response_code": 200,
  "executed_at": "2025-12-22 10:00:00",
  "message": "签到成功",
  "response_body": "..."  // 仅当启用"包含签到响应内容"时包含此字段
}</pre>
                </div>
            </div>
        </section>
    </div>

    <!-- 添加/编辑账号模态框 -->
    <div id="accountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">添加账号</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="accountForm">
                    <input type="hidden" id="accountId">
                    
                    <div class="form-group">
                        <label for="accountName">账号名称 *</label>
                        <input type="text" id="accountName" required>
                    </div>

                    <div class="form-group">
                        <label for="curlCommand">Curl 命令 *</label>
                        <textarea id="curlCommand" rows="6" required placeholder="粘贴完整的 curl 命令，例如：&#10;curl 'https://api.example.com/checkin' \&#10;  -H 'Authorization: Bearer token123' \&#10;  -H 'Content-Type: application/json' \&#10;  --data-raw '{&quot;user_id&quot;: 123}'"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="cronExpr">Cron 表达式 *</label>
                        <input type="text" id="cronExpr" value="0 8 * * *" required>
                        <small>格式：分 时 日 月 周（例如：0 8 * * * 表示每天8点）</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="retryCount">重试次数</label>
                            <input type="number" id="retryCount" value="3" min="0" max="10">
                        </div>

                        <div class="form-group">
                            <label for="retryInterval">重试间隔(秒)</label>
                            <input type="number" id="retryInterval" value="60" min="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enabled" checked>
                            启用定时任务
                        </label>
                    </div>

                    <div class="form-actions">
                        <button type="button" onclick="closeModal()" class="btn btn-secondary">取消</button>
                        <button type="submit" class="btn btn-primary">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 响应详情模态框 -->
    <div id="responseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>响应详情</h3>
                <span class="close" onclick="closeResponseModal()">&times;</span>
            </div>
            <div class="modal-body">
                <pre id="responseContent" style="white-space: pre-wrap; word-wrap: break-word; max-height: 500px; overflow-y: auto; background: #f5f5f5; padding: 15px; border-radius: 4px;"></pre>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentPage = 1;
        let totalPages = 1;

        // HTML 转义函数（防止 XSS）
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/'/g, '&#39;').replace(/"/g, '&quot;');
        }

        // 显示响应详情
        function showResponseDetail(element) {
            const content = element.getAttribute('data-content');
            // 解码 HTML 实体
            const textarea = document.createElement('textarea');
            textarea.innerHTML = content;
            const decoded = textarea.value;

            document.getElementById('responseContent').textContent = decoded;
            document.getElementById('responseModal').style.display = 'block';
        }

        // 关闭响应详情模态框
        function closeResponseModal() {
            document.getElementById('responseModal').style.display = 'none';
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadAccounts();
            loadLogsPage(1);
            loadWebhookConfig();
        });

        // 加载统计数据
        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('totalAccounts').textContent = data.data.total_accounts;
                    document.getElementById('enabledAccounts').textContent = data.data.enabled_accounts;
                    document.getElementById('totalLogs').textContent = data.data.total_logs;
                    document.getElementById('successLogs').textContent = data.data.success_logs;
                }
            } catch (error) {
                console.error('加载统计失败:', error);
            }
        }

        // 加载账号列表
        async function loadAccounts() {
            try {
                const res = await fetch('/api/accounts');
                const data = await res.json();
                
                if (data.success) {
                    const tbody = document.getElementById('accountsBody');
                    
                    if (data.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">暂无账号</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = data.data.map(acc => `
                        <tr>
                            <td>${acc.id}</td>
                            <td>${acc.name}</td>
                            <td>${acc.cron_expr}</td>
                            <td>${acc.retry_count}</td>
                            <td>${acc.retry_interval}</td>
                            <td>
                                <span class="badge ${acc.enabled ? 'badge-success' : 'badge-danger'}">
                                    ${acc.enabled ? '启用' : '禁用'}
                                </span>
                            </td>
                            <td>${acc.created_at}</td>
                            <td>
                                <button onclick="manualCheckin(${acc.id})" class="btn btn-sm btn-success">立即签到</button>
                                <button onclick="editAccount(${acc.id})" class="btn btn-sm btn-primary">编辑</button>
                                <button onclick="deleteAccount(${acc.id})" class="btn btn-sm btn-danger">删除</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('加载账号失败:', error);
            }
        }

        // 加载签到记录（分页）
        async function loadLogsPage(page) {
            if (page < 1) return;

            try {
                const res = await fetch(`/api/logs?page=${page}&page_size=10`);
                const data = await res.json();

                if (data.success) {
                    const tbody = document.getElementById('logsBody');

                    if (data.data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">暂无记录</td></tr>';
                        document.getElementById('logsPagination').style.display = 'none';
                        return;
                    }

                    tbody.innerHTML = data.data.map(log => `
                        <tr>
                            <td>${log.id}</td>
                            <td>${log.account_name}</td>
                            <td>
                                <span class="badge ${log.status === 'success' ? 'badge-success' : 'badge-danger'}">
                                    ${log.status === 'success' ? '成功' : '失败'}
                                </span>
                            </td>
                            <td>${log.response_code || '-'}</td>
                            <td>
                                ${log.response_body ?
                                    `<span class="clickable" data-content="${escapeHtml(log.response_body)}" onclick="showResponseDetail(this)" title="点击查看完整内容">${escapeHtml(log.response_body.substring(0, 50))}...</span>`
                                    : '-'}
                            </td>
                            <td>
                                ${log.error_message ?
                                    `<span class="clickable" data-content="${escapeHtml(log.error_message)}" onclick="showResponseDetail(this)" title="点击查看完整内容">${escapeHtml(log.error_message.substring(0, 30))}...</span>`
                                    : '-'}
                            </td>
                            <td>${log.executed_at}</td>
                        </tr>
                    `).join('');

                    // 更新分页信息
                    currentPage = page;
                    totalPages = Math.ceil(data.total / data.page_size);

                    document.getElementById('pageInfo').textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页 (总计 ${data.total} 条)`;
                    document.getElementById('prevBtn').disabled = currentPage <= 1;
                    document.getElementById('nextBtn').disabled = currentPage >= totalPages;
                    document.getElementById('logsPagination').style.display = 'flex';
                }
            } catch (error) {
                console.error('加载日志失败:', error);
            }
        }

        // 兼容旧的 loadLogs 函数
        function loadLogs() {
            loadLogsPage(1);
        }

        // 显示添加模态框
        function showAddModal() {
            document.getElementById('modalTitle').textContent = '添加账号';
            document.getElementById('accountForm').reset();
            document.getElementById('accountId').value = '';
            document.getElementById('accountModal').style.display = 'block';
        }

        // 编辑账号
        async function editAccount(id) {
            try {
                const res = await fetch('/api/accounts');
                const data = await res.json();
                
                if (data.success) {
                    const account = data.data.find(acc => acc.id === id);
                    
                    if (account) {
                        document.getElementById('modalTitle').textContent = '编辑账号';
                        document.getElementById('accountId').value = account.id;
                        document.getElementById('accountName').value = account.name;
                        document.getElementById('curlCommand').value = account.curl_command;
                        document.getElementById('cronExpr').value = account.cron_expr;
                        document.getElementById('retryCount').value = account.retry_count;
                        document.getElementById('retryInterval').value = account.retry_interval;
                        document.getElementById('enabled').checked = account.enabled;
                        document.getElementById('accountModal').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('加载账号失败:', error);
            }
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('accountModal').style.display = 'none';
        }

        // 提交表单
        document.getElementById('accountForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('accountId').value;
            const formData = {
                name: document.getElementById('accountName').value,
                curl_command: document.getElementById('curlCommand').value,
                cron_expr: document.getElementById('cronExpr').value,
                retry_count: parseInt(document.getElementById('retryCount').value),
                retry_interval: parseInt(document.getElementById('retryInterval').value),
                enabled: document.getElementById('enabled').checked
            };
            
            try {
                const url = id ? `/api/accounts/${id}` : '/api/accounts';
                const method = id ? 'PUT' : 'POST';
                
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert(data.message);
                    closeModal();
                    loadAccounts();
                    loadStats();
                } else {
                    alert('操作失败: ' + data.message);
                }
            } catch (error) {
                alert('操作失败: ' + error.message);
            }
        });

        // 删除账号
        async function deleteAccount(id) {
            if (!confirm('确定要删除这个账号吗？')) return;
            
            try {
                const res = await fetch(`/api/accounts/${id}`, {method: 'DELETE'});
                const data = await res.json();
                
                if (data.success) {
                    alert(data.message);
                    loadAccounts();
                    loadStats();
                } else {
                    alert('删除失败: ' + data.message);
                }
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }

        // 手动签到
        async function manualCheckin(id) {
            if (!confirm('确定要立即执行签到吗？')) return;

            try {
                const res = await fetch(`/api/checkin/${id}`, {method: 'POST'});
                const data = await res.json();

                alert(data.message);

                if (data.success) {
                    loadLogs();
                    loadStats();
                }
            } catch (error) {
                alert('签到失败: ' + error.message);
            }
        }

        // 清除7天前的日志
        async function clearOldLogs() {
            if (!confirm('确定要清除7天前的签到记录吗？\n\n此操作不可恢复！')) return;

            // 二次确认
            if (!confirm('再次确认：真的要删除7天前的所有记录吗？')) return;

            try {
                const res = await fetch('/api/logs/clear?days=7', {method: 'DELETE'});
                const data = await res.json();

                alert(data.message);

                if (data.success) {
                    loadLogs();
                    loadStats();
                }
            } catch (error) {
                alert('清除失败: ' + error.message);
            }
        }

        // 清除全部日志
        async function clearAllLogs() {
            if (!confirm('⚠️ 警告：确定要清除全部签到记录吗？\n\n此操作不可恢复！')) return;

            // 二次确认
            if (!confirm('⚠️ 最后确认：真的要删除所有记录吗？\n\n请输入"确认删除"后点击确定')) {
                return;
            }

            try {
                const res = await fetch('/api/logs/clear', {method: 'DELETE'});
                const data = await res.json();

                alert(data.message);

                if (data.success) {
                    loadLogs();
                    loadStats();
                }
            } catch (error) {
                alert('清除失败: ' + error.message);
            }
        }

        // 点击模态框外部关闭
        window.onclick = function(event) {
            const accountModal = document.getElementById('accountModal');
            const responseModal = document.getElementById('responseModal');
            if (event.target === accountModal) {
                closeModal();
            }
            if (event.target === responseModal) {
                closeResponseModal();
            }
        }

        // 加载 Webhook 配置
        async function loadWebhookConfig() {
            try {
                const res = await fetch('/api/webhook/config');
                const data = await res.json();

                if (data.success) {
                    document.getElementById('webhookEnabled').checked = data.data.enabled || false;
                    document.getElementById('webhookIncludeResponse').checked = data.data.include_response || false;
                    document.getElementById('webhookUrl').value = data.data.url || '';
                    document.getElementById('webhookMethod').value = data.data.method || 'POST';
                    document.getElementById('webhookHeaders').value = data.data.headers || '';
                }
            } catch (error) {
                console.error('加载 Webhook 配置失败:', error);
            }
        }

        // 保存 Webhook 配置
        async function saveWebhook() {
            const config = {
                enabled: document.getElementById('webhookEnabled').checked,
                include_response: document.getElementById('webhookIncludeResponse').checked,
                url: document.getElementById('webhookUrl').value,
                method: document.getElementById('webhookMethod').value,
                headers: document.getElementById('webhookHeaders').value
            };

            // 验证 URL
            if (config.enabled && !config.url) {
                alert('请输入 Webhook URL');
                return;
            }

            // 验证 Headers JSON 格式
            if (config.headers) {
                try {
                    JSON.parse(config.headers);
                } catch (e) {
                    alert('自定义请求头格式错误，请输入有效的 JSON');
                    return;
                }
            }

            try {
                const res = await fetch('/api/webhook/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });

                const data = await res.json();

                if (data.success) {
                    alert('Webhook 配置保存成功');
                } else {
                    alert('保存失败: ' + data.message);
                }
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        }

        // 测试 Webhook
        async function testWebhook() {
            const url = document.getElementById('webhookUrl').value;

            if (!url) {
                alert('请先输入 Webhook URL');
                return;
            }

            if (!confirm('确定要发送测试通知到 Webhook 吗？')) return;

            try {
                const res = await fetch('/api/webhook/test', {method: 'POST'});
                const data = await res.json();

                if (data.success) {
                    alert('测试通知发送成功！\n\n请检查 Webhook 接收端是否收到测试数据。');
                } else {
                    alert('测试失败: ' + data.message);
                }
            } catch (error) {
                alert('测试失败: ' + error.message);
            }
        }
    </script>
</body>
</html>
